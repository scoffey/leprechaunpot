/*
 * Main script
 */
var sokoban = null; // global variable for the sokoban game

window.addEvent('domready', function () {
	// loader and game setup
	var lastLevel = (Cookie.read('postasokoban') || '0').toInt();
	var loader = new SokobanIndexedLevelLoader(mazeDatabase, 'sokoban');
	sokoban = new SokobanGame(loader);
	sokoban.onLevelUp = function () {
		this.echo(this.levelMessage() + ' / '
			+ this.loader.mazeDatabase.length);
		Cookie.write('sokowalter', this.loader.index);
		if (this.levelName > 0 && this.levelName != lastLevel) {
			var levelnum = this.levelName;
			var movecount = (this.history[levelnum] || '').length;
			onReachLevel(levelnum, movecount);
		}
	}.bind(sokoban);
	
	$('start').addEvent('click', function () {
		if (uid != "0") {authUser();}
		run(0);
	});
		
	if (!lastLevel)	{
		$('resume').addClass('disabled');
	} else {
		$('resume').set('text', 'Resume Level '+(lastLevel+1));
		$('resume').addEvent('click', function (e) {
			if (uid != "0") {authUser();}
			sokoban.loadLevel(lastLevel);
			run(lastLevel);
		});
	}
	
});

function run(level) {
	sokoban.loadLevel(level);
	$('splashscreen').setStyle('display', 'none');
	$('content').setStyle('display', 'block');
}
  
function onReachLevel(level, movecount) {
	var url = 'http://www.coffey.com.ar/postasokoban/level?number=' + level + '&movecount=' + movecount;
       FB.api('/me/postasokoban:reach', 'post', {level: url}, function(response) {
	       if (!response || response.error) {
		   console.log('Error occured');
		 } else {
		   console.log('Post was successful! Action ID: ' + response.id);
		 }
       });
}

// Maze database (array of strings that indicate tile states)
// TODO: store sokoban maze data (XSB) in run length encoding (RLE)
var mazeDatabase = [
                    
    // easy
	'#####|#  .#|# $ #|##@##|##$##|#   #|#.  #|#####',
	'#######|#. # .#|# $@$ #|#  #  #|#######',
	'######|#.   #|#$$  #|#@.###|####  ',
	'####### |#+.   ##|# # $$ #|#      #|########',
	'####|#@.#|#$ #|#  #|# $#|#. #|#  #|####',
	' #####|##  .#|#@$  #|#  * #|######',
	'   #####|####   #|#@$  # #|#. $  .#|########',
	'########|#  .#  #|#  $@$ #|#  ## .#|########',
	'####### |#  #  ##|# $@$  #|#. #  .#|########',
	'#####|#  .#|# $ #|##@##|#.$ #|#   #|#  ##|#### ',
	'#######|#@ #  #|#  $$ #|#  . .#|#######',
	'########|#   #  #|#  $@$ #|#  .# .#|########',
	'########|#@ #   #|#  #.  #|#  # $ #|## $ ###| #   #  | #.  #  | #####  ',
	' ####|##@ #|# $ #|#   #|##  #| #$.#| # .#| ####',
	'#####|#@  #|#   #|# $ #|#.$##|#. # |#  # |#### ',
	'#######|#    .#|#    $#|#  #  #|#### ##|  #@$ #|  #.  #|  #####',
	'#####|#@  #|# $ #|## .#| #$ #| # .#| ####',
	'#####|#@  #|#   #|# $ #|#$ ##|#. .#|#   #|#####',
	'########|#+.    #|# $ $  #|####  ##|   #### ',
	'########|# .#@  #|#   $  #|#  *   #|########',
	'#####|#+  #|#  *#|# $ #|##  #| #  #| ####',
	'#####   |#   #   |#   #   |#  #####|##$.#@ #|#    $ #|#   # .#|########',
	'#### |#  # |#. ##|# $@#|# $ #|#. ##|#### ',
	'####### |#@ #..# |#     # |# $ $ ##|#   #  #|#####  #|    ####',

	// medium
	'########|#@ #.  #|#      #|#  #.  #|#  ##  #|# $$   #|#   #  #|########',
	'    ####|    #  #|##### .#|#@  #$ #|#     $#|#     .#|##  #  #| #######',
	'#####   |#@ .#   |#   #   |##$.####|#  #   #|#  $   #|#   ####|#####   ',
	'#### |#..# |# $##|# $@#|# $ #|## .#| ####',
	'########|#@ .#  #|#   $ .#|#   #  #|#### $ #|   #   #|   #   #|   #####',
	'########|#@     #|#  $ $ #|#   ####|#  #..# |#     # |#     # |####### ',
	'  ##### |  #@  # |  #   # |###  $##|#..# $ #|#      #|#      #|########',
	' #####  |##@  #  |# $  #  |#  $ ## |###   ##|  #    #|  #  ..#|  ######',
	'####### |# .  .# |# #   # |#    ## |#   $@##|#  # $ #|####   #|   #####',
	'####    |#@ #####|#  $ $ #|#  ..  #|########',
	'####    |#@ #####|#   #. #|#   #  #|#  #  ##|#  $$ # |#    .# |####### ',
	'#####   |#@  #   |#   #   |# $ ####|#* #.  #|#      #|#   #  #|########',
	'########|#@  #  #|# $ #  #|#   #  #|# $#.  #|#      #|#  #.  #|########',
	'########|#@  #..#|#      #|##   $ #|#   ####|#    $ #|#      #|########',
	'########|#@ . . #|#    # #|####   #|#  $   #|# #$ # #|#      #|########',
	' ###### | #@.. # |## #  ##|#  #   #|# $$   #|##     #| #######',
	' ####  |##@.#  |# $ #  |# $ ###|# $#  #|#.   .#|##  ###| ####  ',
	' #######|##  $@.#|#  $ $.#|#.  ####|#####   ',
	' ####|##@.#|#.  #|# $ #|# $##|#  # |#  # |#### ',
	' #######|##+    #|#  $$  #|#.  #  #|########',
	'  ######|  #@   #|  #    #|  #.. ##|#### $ #|#   $  #|#   #  #|########',
	' #######|##+    #|#  $$  #|#   #  #|## ##  #|#   #  #|#  .#  #|########',
	' ###### | #@ ..# | #$   # | #  ####|##$    #|#      #|#   ####|#####   ',
	'########|#@ # . #|#      #|#  # . #|# $ # ##|# $   # |#   ### |#####   ',
	'#### |#+ ##|#   #|# $.#|##$ #|#   #|#   #|#####',

	// hard
	'########|#@     #|#      #|#   #.##|# $# .# |# $   # |##  ### | ####   ',
	'####### |#     ##|#    $@#|# $ #  #|#  #   #|#  #   #|####. .#|   #####',
	'    ####|   ##@ #|####.  #|#      #|# $ #  #|# #$.  #|#      #|########',
	'#####  |#  .#  |#.$ #  |#   ###|#$ #@ #|#   $.#|##  ###| ####  ',
	' ####|##@ #|# $ #|#.$.#|##$.#|#   #|#   #|#####',
	'#####|#. .#|#  .#|# $ #|##$ #| #@$#| #  #| ####',
	'#####|#. .#|#  .#|# $ #|##$$#| #@ #| #  #| ####',
	'#### |#@ # |#  # |#$$##|#   #|#.$.#|#.  #|#####',
	'####### |#@ #  ##|#      #|#  # ..#|#    $ #|#  $####|#   #   |#####   ',
	'#####|#@  #|# $.#|# $##|# $ #|#.  #|## .#| ####',
	'########|#+   ..#|# $$$# #|## #   #|#  #####|#  #    |#  #    |####    ',
	'#####   |#+  ####|# . .  #|#  $ $ #|## $####| #  #   | #  #   | ####   ',
	'   #####| ###   #| #@ $  #|##   $##|# .#  # |#     # |##. ### | ####   ',
	'######  |#@   #  |# #$ #  |# $  ###|#  #   #|#  . . #|#  #   #|########',
	'#####  |#. .#  |#.  #  |# $ ###|# $#@ #|#   $ #|#  ####|####   ',
	'########|#+ #   #|# $ $  #|#. #  ##|# $ ### |#  .#   |#  ##   |####    ',
	'#####   |#@  ### |# $   # |# $## ##|#  #.  #|#      #|#  #. ##|####### ',
	'#######|#    .#|#  $$ #|#  # .#|##$@###|#.  #  |#   #  |#####  ',
	'########|#@   ..#|# $$$  #|#  #  .#|########',
	' #######|##  #  #|#  $@$ #|#. ##$ #|#      #|#   .  #|#. #   #|########',
	'########|#      #|#    #.#|##$    #|#@ ## .#|# $ #  #|#   #  #|########',
	'########|#@ #  .#|#    #.#|#      #|# $#   #|#* $   #|#   ####|#####   ',
	'########|# .#@  #|# .#$$ #|#    ###|#     # |# #   # |#   ### |#####   ',
	'####### |#@    ##|#      #|#   #  #|##### ##|# $ $  #|#   . .#|########',
	'   #####|   #. .#|#### $ #|#@  #  #|# $ $  #|#. #  ##|####### ',
	
	// impossible
	'########|#@.  . #|# #  # #|#      #|# $ $  #|####.$ #|   #####',
	' ###### |##    ##|#@$  $ #|#  ##  #|#. .#  #|#   #  #|##  ####| ####   ',
	'########|#@     #|# $ $  #|## #   #|#.$.####|#   #   |#  .#   |#####   ',
	'####    |#@ #    |#  #    |# $#####|#  #.  #|#.$ $# #|##    .#| #######',
	'########|#@     #|#..  # #|##  $$ #| ##    #| #. $# #| #     #| #######',
	'   #####|####   #|#      #|#     ##|##..#$@#| #   $ #| ###  ##|   #### ',
	'######  |#@   #  |# #$$#  |#  $ ###|# .# ..#|#      #|#      #|########',
	'  #### |###@ ##|#   $ #|# ##  #|# .#$ #|#    $#|# .  .#|#######',
	' ####  |##@ ###|#. . .#|#  #  #|##  $$#| # $  #| ###  #|   ####',
	'########|#+  . .#|#$     #|#  ## ##|##$ # # | #  $ # | #  ### | ####   ',
	'########|#  #+  #|#  #.$ #|#  * ###|#   $ # |####  # |   #  # |   #### ',
	' ####   | #@ #   | #  #   |##$ ####|#  #.  #|#    $$#|##  . .#| #######',
	'####### |#     # |#.#   # |#     # |#. $####|# #@$  #|# .$   #|########',
	'   #####| ###   #| #+$ # #|##.#   #|#  $ . #|#  $####|#   #   |#####   ',
	' #######|##@ ...#|# $    #|#  ## ##|#   #  #|# $$   #|#   #  #|########',
	'#####   |#.  ####|#. $#@ #|## $   #|#   *  #|#   #  #|##  #  #| #######',
	'   #### | ###@ # | #    # |##.$####|#      #|# .$$  #|# . #  #|########',
	'#####   |#@  ### |#. .  # |#    $##|#.$##  #|# $    #|##  #  #| #######',
	'#####   |#   ####|#  $@  #|##$    #| #  # .#| #$    #| #  #..#| #######',
	'####    |# .#####|#  $@$ #|# $    #|##  ####| #  ..# | ###  # |   #### ',
	'   #### |   #@ # |   #  # |####. ##|#  . $ #|# $ $. #|#####  #|    ####',
	'########|#   #@ #|#   #  #|##$$  ##| #     #| ### ..#|   #####',
	'#####   |#.. ### |#  .  # |## $  ##|####$$@#|#      #|#      #|########',
	'####    |#  #####|#      #|# $#   #|#   ####|#.$$@ # |##  ..# | ###### ',
	'   #####| ###   #| #@$ # #|##$$   #|#  ## ##|#. .   #|##   . #| #######',
	'#####   |#+$.####|#   #  #|# $##  #|#. ##  #|# $$   #|#. #   #|########'
];
